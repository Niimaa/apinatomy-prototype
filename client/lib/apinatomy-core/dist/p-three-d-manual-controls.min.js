!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("jquery"),require("three-js"),require("bluebird"),require("kefir"),require("tweenjs"),require("kefir-jquery"));else if("function"==typeof define&&define.amd)define(["jquery","three-js","bluebird","kefir","tweenjs","kefir-jquery"],t);else{var n="object"==typeof exports?t(require("jquery"),require("three-js"),require("bluebird"),require("kefir"),require("tweenjs"),require("kefir-jquery")):t(e.jQuery,e.THREE,e.P,e.Kefir,e.TWEEN,e.KefirJQuery);for(var r in n)("object"==typeof exports?exports:e)[r]=n[r]}}(this,function(e,t,n,r,o,i){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){var r,o;r=[n(1),n(3),n(2),n(4)],o=function(e,t,n,r){"use strict";var o=e.circuitboard.plugin["do"]("three-d-manual-controls",{requires:["three-d"]}),i={LEFT:1,MIDDLE:2,RIGHT:3};o.append("Circuitboard.prototype.construct",function(){var t=this;this.newProperty("threeDManualControlsEnabled",{initial:!0}),this.newEvent("three-d-manual-controls-used"),this.on("threeDMode").value(!0).onValue(function(){var o=!1;t._screen={},t.on("threeDCanvasSize").onValue(function(e){t._screen.width=e.width,t._screen.height=e.height,t._screen.left=parseFloat(t.threeDCanvasElement.css("left")),t._screen.top=parseFloat(t.threeDCanvasElement.css("top"))}),t.getMouseOnScreen=function(e,r){return new n.Vector2((e-t._screen.left)/t._screen.width,(r-t._screen.top)/t._screen.height)},t.threeDCanvasElement.asKefirStream("contextmenu").onValue(function(e){e.preventDefault()});var a=t.threeDCanvasElement.mouseDrag({threshold:t.options.dragThreshold}).filter(function(){return t.threeDManualControlsEnabled}),u=e(window).asKefirStream("keydown").filter(function(){return t.threeDManualControlsEnabled}),c=e(window).asKefirStream("keyup"),s=t.threeDCanvasElement.mouseWheel().filter(function(){return t.threeDManualControlsEnabled}),f=function(e){return function(t){var n=t.mouseDownEvent;return n.which===e}},l=function(e,t){return function(n){return n.which>=e&&n.which<=(t||e)}};t._rotateStart=new n.Vector3,t._rotateEnd=new n.Vector3;var p=t.threeDCanvasElement.offset();a.filter(f(i.LEFT)).onValue(function(e){var n=e,r=n.mouseDownEvent,i=n.mouseMoveEvent;o=!0,r._pastFirst||(r._pastFirst=!0,t._rotateStart.copy(t.getMouseProjectionOnBall(r.pageX-p.left,r.pageY-p.top))),t._rotateEnd.copy(t.getMouseProjectionOnBall(i.pageX-p.left,i.pageY-p.top))}),t.newProperty("currentArrowKey",{initial:!1}).plug(u.filter(l(37,40)).flatMapLatest(function(e){return r.merge([r.once(e),c.filter(l(e.which)).mapTo(!1).take(1)])})),t.on("currentArrowKey").changes().onValue(function(){o=!0}),t._zoomStart=new n.Vector2,t._zoomEnd=new n.Vector2,a.filter(f(i.MIDDLE)).onValue(function(e){var n=e,r=n.mouseDownEvent,i=n.mouseMoveEvent;o=!0,r._pastFirst||(r._pastFirst=!0,t._zoomStart.copy(t.getMouseOnScreen(r.pageX,r.pageY))),t._zoomEnd.copy(t.getMouseOnScreen(i.pageX,i.pageY))}),s.onValue(function(e){o=!0,e.preventDefault(),e.stopPropagation(),e=e.originalEvent;var n=0;e.wheelDelta?n=e.wheelDelta/40:e.detail&&(n=-e.detail/3),t._zoomStart.y+=.01*n}),t._panStart=new n.Vector2,t._panEnd=new n.Vector2,a.filter(f(i.RIGHT)).onValue(function(e){var n=e,r=n.mouseDownEvent,i=n.mouseMoveEvent;o=!0,r._pastFirst||(r._pastFirst=!0,t._panStart.copy(t.getMouseOnScreen(r.pageX,r.pageY))),t._panEnd.copy(t.getMouseOnScreen(i.pageX,i.pageY))}),t._eye=new n.Vector3,t._panSpeed=1,t._rotateSpeed=1,t.zoomSpeed=1,t.on("3d-render").takeWhileBy(t.p("threeDMode")).onValue(function(){if(o||t.currentArrowKey){if(o=!1,t.event("three-d-manual-controls-used").emit(),t._eye.subVectors(t.camera3D.position,t.camera3D.userData.target),function(){var e=new n.Vector2,r=new n.Vector3,o=new n.Vector3;e.copy(t._panEnd).sub(t._panStart),e.lengthSq()&&(e.multiplyScalar(t._eye.length()*t._panSpeed),o.copy(t._eye),o.cross(t.camera3D.up),o.setLength(e.x),o.add(r.copy(t.camera3D.up).setLength(e.y)),t.camera3D.position.add(o),t.camera3D.userData.semanticTarget||t.camera3D.userData.target.add(o),t._panStart.copy(t._panEnd))}(),function(){var e=new n.Vector3,r=new n.Quaternion,o=Math.acos(t._rotateStart.dot(t._rotateEnd)/t._rotateStart.length()/t._rotateEnd.length());o&&(e.crossVectors(t._rotateStart,t._rotateEnd).normalize(),o*=t._rotateSpeed,r.setFromAxisAngle(e,-o),t._eye.applyQuaternion(r),t.camera3D.up.applyQuaternion(r),t._rotateEnd.applyQuaternion(r),t._rotateStart.copy(t._rotateEnd))}(),function(){if(t.currentArrowKey){var e=t.currentArrowKey,r=e.which,o=e.ctrlKey,i=new n.Vector3;if(38!==r&&40!==r||o)if(37!==r&&39!==r||o){if(37!==r&&39!==r||!o)return;i.set(0,0,1)}else i.set(0,1,0);else i.set(1,0,0);var a=.015*Math.PI*t._rotateSpeed;(39===r||40===r)&&(a*=-1);var u=new n.Quaternion;u.setFromAxisAngle(i,-a),t._eye.applyQuaternion(u),t.camera3D.up.applyQuaternion(u)}}(),function(){if(t.currentArrowKey){var e=t.currentArrowKey,n=e.which,r=e.ctrlKey;38===n&&r?t._zoomStart.y+=.02:40===n&&r&&(t._zoomStart.y-=.02)}}(),function(){var e=1+(t._zoomEnd.y-t._zoomStart.y)*t.zoomSpeed;1!==e&&e>0&&(t._eye.multiplyScalar(e),t._zoomStart.copy(t._zoomEnd))}(),t.options.forbidSubZeroZ){var e=t._eye.length();t.camera3D.userData.target.z<0&&(t.camera3D.userData.target.z=0),t._eye.z<0&&(t._eye.z=0),t._eye.setLength(e)}t.camera3D.position.addVectors(t.camera3D.userData.target,t._eye)}t.camera3D.lookAt(t.camera3D.userData.target)})})}),o.add("Circuitboard.prototype.getMouseProjectionOnBall",function(e,t){var r=new n.Vector3,o=new n.Vector3,i=new n.Vector3;i.set((e-.5*this._screen.width-this._screen.left)/(.5*this._screen.width),(.5*this._screen.height+this._screen.top-t)/(.5*this._screen.height),0);var a=i.length();return a>1?i.normalize():i.z=Math.sqrt(1-a*a),this._eye.copy(this.camera3D.position).sub(this.camera3D.userData.target),r.copy(this.camera3D.up).setLength(i.y),r.add(o.copy(this.camera3D.up).cross(this._eye).setLength(i.x)),r.add(this._eye.setLength(i.z)),r})}.apply(t,r),!(void 0!==o&&(e.exports=o))},function(t){t.exports=e},function(e){e.exports=t},function(e,t,n){var r,o;r=[n(5)],o=function(e){"use strict";var t={newClass:function(e){var t=void 0!==arguments[1]?arguments[1]:{};return e.prototype=t,e.prototype.constructor=e,e},newSubclass:function(e,n){var r=void 0!==arguments[2]?arguments[2]:{},o=n(e.prototype.constructor);return o.prototype=Object.create(e.prototype),t.extend(o.prototype,r),o.prototype.constructor=o,o},extend:function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return t.forEach(function(t){for(var n in t)t.hasOwnProperty(n)&&Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}),e},field:function(e){return function(t){return t[e]}},call:function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return e.apply(void 0,t)},id:function(e){return e},getDef:function(e,n,r){return t.isUndefined(e[n])&&("function"==typeof r&&(r=r()),e[n]=r),e[n]},object:function(e,n){return t.getDef(e,n,{})},array:function(e,n){return t.getDef(e,n,[])},pull:function(e,t){var n=e.indexOf(t);-1!==n&&e.splice(n)},makeEmpty:function(e){for(;e.length>0;)e.pop()},bindA:function(e,t,n){return e.bind.apply(e,[t].concat(n))},bind:function(e,n){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];return t.bindA(e[n],e,r)},applyConstructor:function(e,t){var n=e.bind.apply(e,[null].concat(t));return new n},assert:function(e,t){if(!e)throw new Error(t||"Assertion failed")},isUndefined:function(e){return"undefined"==typeof e},isDefined:function(e){return"undefined"!=typeof e},isPlainObject:function(e){return"object"==typeof e&&e.constructor===Object},isFunction:function(e){return"function"==typeof e},objValues:function(e){return Object.keys(e).map(function(t){return e[t]})},makePositioned:function(e){"static"===e.css("position")&&e.css("position","relative")},defOr:function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];for(var r=0;r<e.length;r+=1)if(t.isDefined(e[r]))return e[r]},debounce:function(e,t,n){var r;return function(){for(var o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];var a=this,u=function(){r=null,e.apply(n||a,o)};clearTimeout(r),r=setTimeout(u,t)}},oncePerStack:function(e,t){var n=!0,r=function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];n&&(n=!1,setTimeout(function(){n=!0},0),e.apply(t||this,r))};return r.allowAdditionalCall=function(){n=!0},r},cached:function(e){function n(){var e=o(),t=a;i(e,t)||(a=e,s.forEach(function(n){return n(e,t)}))}var r=e,o=r.retrieve,i=r.isEqual;i=i||function(e,t){return e===t};var a,u=t.oncePerStack(n),c=function(){return u(),a},s=[];return c.onChange=function(e){return s.push(e),c},c.allowAdditionalCall=function(){u.allowAdditionalCall()},u(),c},promisify:function(t,n){return function(){for(var r=[],o=0;o<arguments.length;o++)r[o]=arguments[o];return new e(function(e,o){try{t[n].apply(t,r.concat(e))}catch(i){o(i)}})}},findIndex:function(e,t){for(var n=0;n<e.length;++n)if(t(e[n],n,e))return n;return-1},memoize:function(e){var n=[],r=[];return function(){for(var o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];var a=t.findIndex(n,function(e){return e.every(function(e,t){return e===o[t]})});if(a>=0)return r[a];var u=e.apply(this,o);return n.push(o),r.push(u),u}}},n=1e-6,r=function(e,t){return e>t-n&&t+n>e};return t.Position=t.newClass(function(e,t){this.top=e,this.left=t}),t.Position.subtract=function(e,n){return new t.Position(e.top-n.top,e.left-n.left)},t.Position.equals=function(e,n){return t.isDefined(e)&&t.isDefined(n)&&r(e.top,n.top)&&r(e.left,n.left)},t.Size=t.newClass(function(e,t){this.height=e,this.width=t}),t.Size.equals=function(e,n){return t.isDefined(e)&&t.isDefined(n)&&r(e.height,n.height)&&r(e.width,n.width)},t}.apply(t,r),!(void 0!==o&&(e.exports=o))},function(e,t,n){var r,o;r=[n(1),n(3),n(6),n(7),n(8)],o=function(e,t,n,r,o){o.init(n,e),n.fromOnNull=t.memoize(function(e,t){return n.fromBinder(function(n){return e.on(t,n.emit),function(){e.on(t,null)}})});var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)};return n.animationFrames=function(){return n.fromBinder(function(e){var t=!0;return function n(){i(function(){e.emit(),t&&n()})}(),function(){t=!1}})},n.tween=function(e,t,o){var i=o,a=i.duration,u=i.delay,c=i.easing,s=new r.Tween(e).to(t,a),f=n.bus(),l=function(){var e=0;return function(t){e+=1,f.plug(t),t.onEnd(function(){e-=1,0===e&&f.end()})}}();return l(n.fromBinder(function(e){c&&s.easing(c),u&&s.delay(u),s.onUpdate(function(){e.emit(this)}),s.onComplete(e.end)})),f.tween=s,f.start=function(){return s.start(),f},f.chain=function(e){return l(e),s.chain(e.tween),f},f},n.keyPress=function(t){return e(window).asKefirStream("keypress").filter(function(e){return e.keyCode===t})},n.once=function(e){return n.fromBinder(function(t){t.emit(e),t.end()})},n.fromArray=function(e){return n.fromBinder(function(t){e.forEach(t.emit),t.end()})},n.limiter=function(e){var r=void 0!==arguments[1]?arguments[1]:t.call,o=n.bus(),i=n.bus(),a=n.bus();return e.filterBy(o.toProperty(!1)).onValue(function(){r(function(){i.emit(),o.emit(!1),a.emit()})}),function(e){var t=(void 0!==arguments[1]?arguments[1]:{}).buffer;return o.plug(e.mapTo(!0)),n.constant(!0).take(1).concat(a).flatMapLatest(function(){var r=function(e,n){return t?e.concat([n]):[n]};return e.takeUntilBy(i).reduce(r,[]).flatMap(n.fromArray)})}},n.Observable.prototype.limitedBy=function(e,t){return e(this,t)},n.Stream.prototype.holdUntil=function(e){var t=this;return n.fromBinder(function(n){var r=[],o=t.onValue(function(e){r.push(e)}),i=e.onValue(function(){if(r.length>0){var e=r;r=[],e.forEach(n.emit)}});return function(){o(),i(),r=null}})},n.Observable.prototype.value=function(e,t){return t=t||function(t){return t===e},this.skipDuplicates().filter(t)},n.Observable.prototype.run=function(){var e=this,t=function(){};return this.onValue(t),function(){e.offValue(t)}},n.Stream.prototype.skipPropagation=function(e){return this.filter(function(n){return!t.array(n.originalEvent,"_onlyOnceFor")[e]}).map(function(n){t.array(n.originalEvent,"_onlyOnceFor")[e]=!0})},n.Stream.prototype.which=function(e){var t="function"==typeof e?e:function(t){return t===e};return this.filter(function(e){return t(e.which)})},e.fn.mouseDrag=function(){var t=(void 0!==arguments[0]?arguments[0]:{}).threshold;return e(this).asKefirStream("mousedown").flatMap(function(n){var r=e(document).asKefirStream("mousemove");if(t){var o=!1;r=r.filter(function(e){if(o)return!0;var r=n.pageX-e.pageX,i=n.pageY-e.pageY;return r*r+i*i>t*t?o=!0:!1})}return r.takeUntilBy(e(document).asKefirStream("mouseup")).map(function(e){return{mouseDownEvent:n,mouseMoveEvent:e}})})},e.fn.mouseClick=function(){var t=(void 0!==arguments[0]?arguments[0]:{}).threshold;return e(this).asKefirStream("mousedown").flatMap(function(n){var r=e(document).asKefirStream("mousemove");if(t){var o=!1;r=r.filter(function(e){if(o)return!0;var r=n.pageX-e.pageX,i=n.pageY-e.pageY;return r*r+i*i>t*t?o=!0:!1})}return e(document).asKefirStream("mouseup").take(1).takeUntilBy(r)})},e.fn.mouseWheel=function(){return e(this).asKefirStream("mousewheel DOMMouseScroll")},n}.apply(t,r),!(void 0!==o&&(e.exports=o))},function(e){e.exports=n},function(e){e.exports=r},function(e){e.exports=o},function(e){e.exports=i}])});